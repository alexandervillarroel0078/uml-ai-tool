from fastapi.responses import JSONResponse
import json

@router.get("/{diagram_id}/export", response_class=JSONResponse)
def export_diagram(
    diagram_id: UUID,
    db: Session = Depends(get_db),
    me: User = Depends(get_current_user),
):
    d = get_my_diagram(db, me, diagram_id)

    # Todas las clases
    clases = db.query(Clase).filter(Clase.diagram_id == d.id).all()
    clases_out = [ClaseCompletaOut.model_validate(c).model_dump(by_alias=True) for c in clases]

    # Todas las relaciones
    relaciones = db.query(Relacion).filter(Relacion.diagram_id == d.id).all()
    relaciones_out = []
    for r in relaciones:
        relaciones_out.append(
            RelacionOutExpanded.model_validate({
                **r.__dict__,
                "origen": ClaseCompletaOutLight.model_validate(r.origen),
                "destino": ClaseCompletaOutLight.model_validate(r.destino),
            }).model_dump(by_alias=True)
        )

    export_data = {
        "diagram": {
            "id": str(d.id),
            "nombre": d.nombre,
            "clases": clases_out,
            "relaciones": relaciones_out
        }
    }

    return JSONResponse(
        content=export_data,
        headers={
            "Content-Disposition": f"attachment; filename=diagram_{d.id}.json"
        }
    )
